<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sugerencias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* ... (Tu CSS permanece igual) ... */
    /* Estilos espec√≠ficos para botones de administrador */
    .admin-action-btn {
        background-color: #8B0000; /* Vinotinto para eliminar */
    }
    .admin-action-btn.favorite {
        background-color: #007bff; /* Azul para favorito */
    }
    .admin-action-btn:hover {
        background-color: #a00000; /* Vinotinto m√°s oscuro al pasar el mouse */
    }
    .admin-action-btn.favorite:hover {
        background-color: #0056b3; /* Azul m√°s oscuro al pasar el mouse */
    }
  </style>
</head>
<body>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    // Tu configuraci√≥n de Firebase:
    const firebaseConfig = {
      apiKey: "AIzaSyCOy5Gp1owFTLE78pz7RaKX48KnE0q5_3g",
      authDomain: "innovaccionunefa-b651f.firebaseapp.com",
      projectId: "innovaccionunefa-b651f",
      storageBucket: "innovaccionunefa-b651f.firebasestorage.app",
      messagingSenderId: "1072624735711",
      appId: "1:1072624735711:web:bfaa90d76a46840fc9a06a"
    };

    // Inicializar Firebase si no ha sido inicializado
    // Esta es la forma CORRECTA de inicializar con las SDKs "compat"
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ... (El resto de tu JavaScript permanece igual) ...
    // Aseg√∫rate de que las funciones likeSuggestion, dislikeSuggestion, markFavorite, markDislike, y deleteSuggestion
    // tengan la l√≥gica y los botones de administrador que hab√≠amos a√±adido previamente en la respuesta anterior.
    // Tambi√©n, ten en cuenta que tus funciones de admin markFavorite y markDislike para el admin
    // tienen el mismo comportamiento que los likes/dislikes de usuario, lo cual es redundante.
    // Para el admin, solo necesitas `markFavorite` (que alterna el estado de favorito) y `deleteSuggestion`.

    // **REVISI√ìN DE BOTONES DE ADMIN EN loadSuggestions**:
    // En el archivo "sugerencias (1).html", los botones de admin han cambiado de nuevo.
    // Volvamos a la versi√≥n anterior que ten√≠a los botones de Eliminar y Favorito correctos,
    // y solo necesitamos una funci√≥n para marcar/desmarcar Favorito.
    async function loadSuggestions(){
      const ul=suggestionList;
      ul.innerHTML="";
      let q=db.collection("sugerencias");
      const f=filterSelect.value;
      
      if(f==="mostViewed") q=q.orderBy("viewCount","desc");
      else if(f==="recent") q=q.orderBy("timestamp","desc");
      else if(f==="old") q=q.orderBy("timestamp","asc");

      try {
        const snap=await q.get();
        if (snap.empty) {
            ul.innerHTML = '<li style="text-align: center; color: #aaa;">No hay sugerencias disponibles.</li>';
            return;
        }

        snap.forEach(doc=>{
          const d=doc.data();
          const li=document.createElement("li");
          li.dataset.id = doc.id; // Guarda el ID del documento
          li.innerHTML=`
            <strong>${d.title}</strong><br>
            ${d.text}
            <div class="suggestion-meta">
                <span>üëÅ ${d.viewCount || 0}</span>
                <span>üëç ${Object.values(d.likes || {}).filter(val => val === true).length}</span>
                <span>üëé ${Object.values(d.likes || {}).filter(val => val === false).length}</span>
            </div>
            <div class="suggestion-actions"></div>
          `;
          
          const actionsDiv = li.querySelector(".suggestion-actions");

          // Botones para usuarios normales
          if (auth.currentUser && !window.isAdmin) {
              const likeBtn = document.createElement("button");
              likeBtn.textContent = "üëç Like"; // A√±adimos icono
              likeBtn.onclick = (e) => { e.stopPropagation(); likeSuggestion(doc.id); };
              actionsDiv.appendChild(likeBtn);

              const dislikeBtn = document.createElement("button");
              dislikeBtn.textContent = "üëé Dislike"; // A√±adimos icono
              dislikeBtn.onclick = (e) => { e.stopPropagation(); dislikeSuggestion(doc.id); };
              actionsDiv.appendChild(dislikeBtn);

              // Actualizar el estado visual de los botones de like/dislike
              updateReactionUI(doc.id, likeBtn, dislikeBtn, d.likes);
          }
          
          // Botones para administrador
          if (window.isAdmin) {
              // Bot√≥n de Favorito
              const favBtn = document.createElement("button");
              favBtn.textContent = "‚òÖ Favorito";
              favBtn.classList.add('admin-action-btn', 'favorite');
              favBtn.onclick = (e) => { e.stopPropagation(); markFavorite(doc.id); };
              // Opcional: mostrar visualmente si el admin ya lo marc√≥
              if (d.favorites && d.favorites.admin === true) {
                  favBtn.classList.add('active'); // O una clase diferente para favorito
              }
              actionsDiv.appendChild(favBtn);

              // Bot√≥n de Eliminar
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "üóë Eliminar";
              deleteBtn.classList.add('admin-action-btn');
              deleteBtn.onclick = (e) => { e.stopPropagation(); deleteSuggestion(doc.id, d.videoURL, d.imageURLs); };
              actionsDiv.appendChild(deleteBtn);
          }

          li.onclick=()=>incrementView(doc.id); // Incrementa la vista al hacer clic
          ul.appendChild(li);
        });
      } catch (e) {
        console.error("Error al cargar sugerencias:", e);
        ul.innerHTML = '<li style="text-align: center; color: red;">Error al cargar las sugerencias.</li>';
      }
    }
    
    // Y aseg√∫rate de tener la funci√≥n deleteFile y deleteSuggestion
    // que se a√±adi√≥ en la respuesta anterior para que el bot√≥n de eliminar funcione:
    async function deleteFile(url) {
        if (!url) return;
        try {
            const ref = storage.refFromURL(url);
            await ref.delete();
            console.log("Archivo eliminado de Storage:", url);
        } catch (error) {
            console.warn("No se pudo eliminar el archivo de Storage (puede que no exista o no haya permisos):", url, error);
        }
    }

    async function deleteSuggestion(id, videoURL, imageURLs){
      if (!window.isAdmin) { 
        alert("Acceso denegado: solo el administrador puede eliminar sugerencias.");
        return;
      }

      if (confirm("¬øEst√°s seguro de que quieres eliminar esta sugerencia? Esta acci√≥n es irreversible.")) {
        try {
          // 1. Eliminar archivos de Storage
          if (videoURL) {
              await deleteFile(videoURL);
          }
          if (imageURLs && imageURLs.length > 0) {
              for (const url of imageURLs) {
                  await deleteFile(url);
              }
          }

          // 2. Eliminar el documento de Firestore
          await db.collection("sugerencias").doc(id).delete();
          alert("Sugerencia eliminada exitosamente.");
          loadSuggestions(); // Recargar la lista
        } catch (e) {
          console.error("Error al eliminar sugerencia:", e);
          alert("Error al eliminar la sugerencia: " + e.message);
        }
      }
    }

    // La funci√≥n markDislike para el admin ya no es necesaria si solo tienes un bot√≥n de "Favorito" que alterna.
    // Si quieres un bot√≥n "No Favorito" separado, lo podr√≠as reintroducir, pero generalmente "Favorito" se alterna.
    // Por simplicidad y funcionalidad, el `markFavorite` ya deber√≠a alternar el estado.
    // Tu funci√≥n `markDislike` para el admin del archivo "sugerencias (1).html" es:
    /*
    async function markDislike(id){
      if (!window.isAdmin) { return alert("Acceso denegado: solo el administrador puede marcar como no favorito."); }
      try {
        const docRef = db.collection("sugerencias").doc(id);
        const docSnap = await docRef.get();
        const currentFavorites = docSnap.data().favorites || {};
        if (currentFavorites.admin === false) { // Si ya es no favorito, quitarlo
            await docRef.update({ 'favorites.admin': firebase.firestore.FieldValue.delete() });
        } else { // Si no es no favorito, marcarlo
            await docRef.update({ 'favorites.admin': false });
        }
        loadSuggestions();
      } catch (e) {
        console.error("Error al marcar como no favorito:", e);
        alert("Error al marcar como no favorito: " + e.message);
      }
    }
    */
    // Puedes eliminarla si prefieres que el bot√≥n de favorito simplemente alterne true/false/delete.
    // Si la mantienes, aseg√∫rate de a√±adirle los estilos `admin-action-btn` como al bot√≥n de favorito.

    // **IMPORTANTE: AUTENTICACI√ìN DE ADMINISTRADOR**
    // El c√≥digo en el archivo "sugerencias (1).html" NO incluye la l√≥gica para que el usuario "ChamoProgramador"
    // con la contrase√±a "29072024" se registre o inicie sesi√≥n con esas credenciales fijas y se le asigne el rol de admin.
    // Esa l√≥gica S√ç estaba en la respuesta anterior. Debes reintroducirla en la funci√≥n `login()`.

    async function login(){
      const u = loginUsername.value.trim(), p = loginPassword.value;
      if(!u||!p){ return alert("Usuario y contrase√±a obligatorios."); }
      
      // Credenciales fijas para el administrador
      if (u === "ChamoProgramador" && p === "29072024") {
          try {
              // Intenta iniciar sesi√≥n con un email dummy para ChamoProgramador
              await auth.signInWithEmailAndPassword("chamoprogramador@dummy.com", p);
              // Si no existe, lo crea. Esto es para que Firebase Auth lo reconozca.
              if (!auth.currentUser.displayName) {
                  await auth.currentUser.updateProfile({displayName: "ChamoProgramador"});
              }
              hideLoginForm();
              alert("Inicio de sesi√≥n de administrador exitoso.");
          } catch (e) {
              // Si el usuario chamoprogramador@dummy.com no existe, lo crea
              if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                  try {
                      const cred = await auth.createUserWithEmailAndPassword("chamoprogramador@dummy.com", p);
                      await cred.user.updateProfile({displayName: "ChamoProgramador"});
                      hideLoginForm();
                      alert("Administrador creado e iniciado sesi√≥n.");
                  } catch (createError) {
                      alert("Error al crear o iniciar sesi√≥n como administrador: " + createError.message);
                      console.error("Admin create/login error:", createError);
                  }
              } else {
                  alert("Error al iniciar sesi√≥n como administrador: " + e.message);
                  console.error("Admin login error:", e);
              }
          }
          return; // Salir de la funci√≥n despu√©s de intentar el login del admin
      }

      // L√≥gica para usuarios normales (no admin)
      const email = u.toLowerCase()+"@dummy.com"; // Usamos un email dummy para Firebase Auth
      try {
        await auth.signInWithEmailAndPassword(email,p);
        hideLoginForm();
        alert("Inicio de sesi√≥n exitoso.");
      } catch(e) {
        alert("Error al iniciar sesi√≥n: " + e.message);
        console.error("Login error:", e);
      }
    }


    function applyFilter(){ loadSuggestions(); }

    // Cargar sugerencias al inicio y cada vez que el estado de autenticaci√≥n cambie
    document.addEventListener('DOMContentLoaded', () => {
        // La carga inicial se maneja en onAuthStateChanged
    });
  </script>
</body>
</html>
