<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sugerencias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* RESET B√ÅSICO */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#333; color:#fff; font-family:Arial,sans-serif;
      padding:20px; position:relative;
      min-height: 100vh; /* Asegura que el cuerpo ocupe toda la altura */
    }
    /* Navegaci√≥n superior izquierda */
    #navButtons {
      position:fixed; top:10px; left:10px; z-index:1000;
    }
    #navButtons button {
      background:#444; border:2px solid #000; color:#fff;
      padding:8px 12px; margin-right:5px; border-radius:4px;
      font-weight:bold; cursor:pointer;
      transition: background 0.3s ease;
    }
    #navButtons button:hover { background:#555; }
    /* Auth superior derecha */
    #authSection {
      position:fixed; top:10px; right:10px; z-index:1000;
      display: flex; align-items: center;
    }
    #authSection span { margin-right:10px; font-size:14px; color: #ccc; }
    #authSection button {
      background:#444; border:2px solid #000; color:#fff;
      padding:6px 10px; margin-right:5px; border-radius:4px;
      cursor:pointer;
      transition: background 0.3s ease;
    }
    #authSection button:hover { background:#555; }
    /* Modales login/registro */
    .modal {
      display:none; position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      z-index:1001;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
        background:#282828;
        border:2px solid #000; padding:20px;
        border-radius:8px;
        width: 90%; max-width: 300px;
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
        position: relative;
    }
    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
    }
    .modal-close:hover {
        color: #fff;
    }
    .modal h2 {
        text-align: center;
        margin-bottom: 15px;
        color: #eee;
    }
    .modal input {
      display:block; width:calc(100% - 20px); margin:10px auto; padding:8px 10px;
      border:1px solid #555; border-radius:4px; background:#333; color:#fff;
    }
    .modal button {
      display:block; width:calc(100% - 20px); margin:10px auto;
      background:#555; border:none; color:#fff; cursor:pointer;
      padding:10px 15px; border-radius:4px;
      transition: background 0.3s ease;
    }
    .modal button:hover { background:#666; }
    /* Layout dos columnas */
    .main-container {
      display:flex; gap:20px; margin-top:60px;
      flex-wrap: wrap;
    }
    /* Izquierda: lista */
    .left-sidebar {
      flex: 1;
      min-width: 300px;
      background:#222; padding:10px;
      border-radius:4px; max-height:calc(100vh - 100px);
      overflow-y:auto;
      border: 1px solid #000;
    }
    .left-sidebar h2 { text-align:center; margin-bottom:10px; color: #eee; }
    .left-sidebar ul { list-style:none; }
    .left-sidebar li {
      background: #333;
      padding:12px; border-bottom:1px solid #444;
      font-size:14px; cursor:pointer;
      margin-bottom: 8px;
      border-radius: 4px;
      transition: background 0.3s ease;
      position: relative;
    }
    .left-sidebar li:last-child { border-bottom: none; }
    .left-sidebar li:hover { background:#444; }
    .suggestion-meta {
        font-size: 0.8em;
        color: #bbb;
        margin-top: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .suggestion-actions {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #444;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
    }
    .suggestion-actions button {
        background: #555;
        border: none;
        color: #fff;
        padding: 5px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.7em;
        transition: background 0.3s ease;
        flex-grow: 1;
        min-width: 60px;
    }
    .suggestion-actions button:hover {
        background: #777;
    }
    .suggestion-actions button.active {
        background-color: #007bff;
    }
    /* Estilos espec√≠ficos para botones de administrador */
    .admin-action-btn {
        background-color: #8B0000; /* Vinotinto para eliminar */
    }
    .admin-action-btn.favorite {
        background-color: #007bff; /* Azul para favorito */
    }
    .admin-action-btn:hover {
        background-color: #a00000; /* Vinotinto m√°s oscuro al pasar el mouse */
    }
    .admin-action-btn.favorite:hover {
        background-color: #0056b3; /* Azul m√°s oscuro al pasar el mouse */
    }

    /* Derecha: formulario */
    .right-container {
      flex: 1;
      min-width: 300px;
      background:#000; padding:20px;
      border-radius:4px;
      border: 1px solid #222;
    }
    .right-container h1 {
      text-align:center; margin-bottom:20px; font-size:24px; color: #eee;
    }
    .suggestion-input input[type="text"],
    .suggestion-input textarea {
      width:calc(100% - 16px); padding:8px; margin-bottom:10px;
      border:1px solid #555; border-radius:4px; font-size:14px;
      background:#222; color:#fff;
    }
    .suggestion-input label { margin:10px 0 5px; display:block; color: #ccc; }
    .suggestion-input input[type="file"] { margin-bottom:10px; background:#222; padding:5px; border-radius:4px; border:1px solid #555; }
    .suggestion-input button {
      background:#007bff;
      color:#fff; border:none;
      border-radius:44px; padding:10px 20px;
      cursor:pointer; font-size:14px;
      width: 100%;
      transition: background 0.3s ease;
    }
    .suggestion-input button:hover { background:#0056b3; }
    .message { margin-top:10px; font-size:14px; text-align:center; color: yellow; }
    /* Filtro */
    .filter-section {
      margin-top:20px; text-align:center;
      padding-top: 20px;
      border-top: 1px solid #222;
    }
    .filter-section select {
      padding:8px; font-size:14px;
      border:1px solid #555; border-radius:4px;
      background:#222; color:#fff;
      width: 100%; max-width: 200px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .main-container {
            flex-direction: column;
        }
        .left-sidebar, .right-container {
            width: 100%;
            min-width: unset;
        }
        #navButtons, #authSection {
            position: static;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #authSection {
            margin-top: 10px;
        }
        body { padding: 10px; }
        .main-container { margin-top: 20px; }
    }
  </style>
</head>
<body>

  <div id="navButtons">
    <button onclick="history.back()">Regresar</button>
    <button onclick="window.location.href='index.html'">Inicio</button>
  </div>

  <div id="authSection">
    <span id="userStatus">No autenticado</span>
    <button id="loginBtn" onclick="showLoginForm()">Iniciar Sesi√≥n</button>
    <button id="registerBtn" onclick="showRegisterForm()">Registrarse</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">Cerrar Sesi√≥n</button>
  </div>

  <div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="hideLoginForm()">&times;</span>
        <h2>Iniciar Sesi√≥n</h2>
        <input type="text" id="loginUsername" placeholder="Usuario">
        <input type="password" id="loginPassword" placeholder="Contrase√±a">
        <button onclick="login()">Iniciar Sesi√≥n</button>
    </div>
  </div>

  <div id="registerModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="hideRegisterForm()">&times;</span>
        <h2>Registrarse</h2>
        <input type="text" id="registerUsername" placeholder="Usuario">
        <input type="password" id="registerPassword" placeholder="Contrase√±a">
        <button onclick="register()">Registrarse</button>
    </div>
  </div>

  <div class="main-container">
    <div class="left-sidebar">
      <h2>Comentarios</h2>
      <ul id="suggestionList"></ul>
    </div>
    <div class="right-container">
      <h1>Nueva Sugerencia</h1>
      <div class="suggestion-input">
        <input type="text" id="suggestionTitle" placeholder="T√≠tulo de la sugerencia">
        <textarea id="suggestionText" rows="3" placeholder="Escribe tu sugerencia..."></textarea>
        <label>Adjunta un video (m√°x. 30 segundos):</label>
        <input type="file" id="videoInput" accept="video/*">
        <label>Adjunta hasta 3 im√°genes:</label>
        <input type="file" id="imageInput" accept="image/*" multiple>
        <button onclick="submitSuggestion()">Enviar Sugerencia</button>
        <div class="message" id="message"></div>
      </div>
      <div class="filter-section">
        <select id="filterSelect" onchange="applyFilter()">
          <option value="mostViewed" selected>M√°s Vistos</option>
          <option value="recent">Recientes</option>
          <option value="old">Antiguos</option>
        </select>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    // Tu configuraci√≥n de Firebase:
    const firebaseConfig = {
      apiKey: "AIzaSyCOy5Gp1owFTLE78pz7RaKX48KnE0q5_3g", // <-- Verifica que este sea tu API Key de Firebase
      authDomain: "innovaccionunefa-b651f.firebaseapp.com", // <-- Verifica que este sea tu Auth Domain
      projectId: "innovaccionunefa-b651f", // <-- Verifica que este sea tu Project ID
      storageBucket: "innovaccionunefa-b651f.firebasestorage.app", // <-- Verifica que este sea tu Storage Bucket
      messagingSenderId: "1072624735711",
      appId: "1:1072624735711:web:bfaa90d76a46840fc9a06a"
    };

    // Inicializar Firebase si no ha sido inicializado
    // Esta es la forma CORRECTA de inicializar con las SDKs "compat"
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Referencias a elementos del DOM
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginModal = document.getElementById("loginModal");
    const registerModal = document.getElementById("registerModal");
    const loginUsername = document.getElementById("loginUsername");
    const loginPassword = document.getElementById("loginPassword");
    const registerUsername = document.getElementById("registerUsername");
    const registerPassword = document.getElementById("registerPassword");
    const suggestionTitle = document.getElementById("suggestionTitle");
    const suggestionText = document.getElementById("suggestionText");
    const videoInput = document.getElementById("videoInput");
    const imageInput = document.getElementById("imageInput");
    const message = document.getElementById("message");
    const suggestionList = document.getElementById("suggestionList");
    const filterSelect = document.getElementById("filterSelect");

    // Monitorear estado de autenticaci√≥n
    auth.onAuthStateChanged(user => {
      const status = document.getElementById("userStatus");
      if (user) {
        const name = user.displayName || user.email.split("@")[0];
        status.textContent = `Bienvenido, ${name}`;
        loginBtn.style.display = "none";
        registerBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        // Asumiendo que el admin es "ChamoProgramador2007" (case insensitive)
        window.isAdmin = name.toLowerCase() === "chamoprogramador2007"; 
      } else {
        status.textContent = "No autenticado";
        loginBtn.style.display = "inline-block";
        registerBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        window.isAdmin = false;
      }
      loadSuggestions(); // Recargar sugerencias para actualizar la UI seg√∫n el rol
    });

    // Mostrar/ocultar modales
    function showLoginForm(){ loginModal.style.display="flex"; }
    function hideLoginForm(){ loginModal.style.display="none"; }
    function showRegisterForm(){ registerModal.style.display="flex"; }
    function hideRegisterForm(){ registerModal.style.display="none"; }

    // Autenticaci√≥n user/pass simulada con email dummy
    async function login(){
      const u = loginUsername.value.trim(), p = loginPassword.value;
      if(!u||!p){ return alert("Usuario y contrase√±a obligatorios."); }
      
      // Credenciales fijas para el administrador
      if (u === "ChamoProgramador2007" && p === "20072024") { // <--- ¬°Nuevas credenciales de administrador!
          try {
              // Intenta iniciar sesi√≥n con un email dummy para ChamoProgramador2007
              await auth.signInWithEmailAndPassword("chamoprogramador2007@dummy.com", p);
              // Si no existe, lo crea. Esto es para que Firebase Auth lo reconozca.
              if (!auth.currentUser.displayName) {
                  await auth.currentUser.updateProfile({displayName: "ChamoProgramador2007"});
              }
              hideLoginForm();
              alert("Inicio de sesi√≥n de administrador exitoso.");
          } catch (e) {
              // Si el error es por usuario no encontrado o contrase√±a incorrecta para el dummy,
              // intentamos registrarlo, ya que ChamoProgramador2007 es una cuenta "fija".
              if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                  try {
                      const cred = await auth.createUserWithEmailAndPassword("chamoprogramador2007@dummy.com", p);
                      await cred.user.updateProfile({displayName: "ChamoProgramador2007"});
                      hideLoginForm();
                      alert("Administrador creado e iniciado sesi√≥n.");
                  } catch (createError) {
                      alert("Error al crear o iniciar sesi√≥n como administrador: " + createError.message);
                      console.error("Admin create/login error:", createError);
                  }
              } else {
                  alert("Error al iniciar sesi√≥n como administrador: " + e.message);
                  console.error("Admin login error:", e);
              }
          }
          return; // Salir de la funci√≥n despu√©s de intentar el login del admin
      }

      // L√≥gica para usuarios normales (no admin)
      const email = u.toLowerCase()+"@dummy.com"; // Usamos un email dummy para Firebase Auth
      try {
        await auth.signInWithEmailAndPassword(email,p);
        hideLoginForm();
        alert("Inicio de sesi√≥n exitoso.");
      } catch(e) {
        alert("Error al iniciar sesi√≥n: " + e.message);
        console.error("Login error:", e);
      }
    }

    async function register(){
      const u = registerUsername.value.trim(), p = registerPassword.value;
      if(!u||!p){ return alert("Usuario y contrase√±a obligatorios."); }
      if(p.length < 6) { return alert("La contrase√±a debe tener al menos 6 caracteres."); } // Firebase Auth min password length
      const email = u.toLowerCase()+"@dummy.com"; // Usamos un email dummy para Firebase Auth
      try {
        const cred = await auth.createUserWithEmailAndPassword(email,p);
        await cred.user.updateProfile({displayName:u}); // Guarda el nombre de usuario
        hideRegisterForm();
        alert("Registro exitoso. Ahora puedes iniciar sesi√≥n.");
      } catch(e) {
        alert("Error al registrar: " + e.message);
        console.error("Register error:", e);
      }
    }

    function logout(){ 
        auth.signOut().then(() => {
            alert("Sesi√≥n cerrada.");
        }).catch((error) => {
            console.error("Error al cerrar sesi√≥n:", error);
            alert("Error al cerrar sesi√≥n.");
        });
    }

    // Subir archivo a Storage
    async function uploadFile(file,path){
      const ref = storage.ref(path);
      const snapshot = await ref.put(file);
      return snapshot.ref.getDownloadURL();
    }

    // Eliminar archivo de Storage
    async function deleteFile(url) {
        if (!url) return;
        try {
            const ref = storage.refFromURL(url);
            await ref.delete();
            console.log("Archivo eliminado de Storage:", url);
        } catch (error) {
            console.warn("No se pudo eliminar el archivo de Storage (puede que no exista o no haya permisos):", url, error);
        }
    }

    // Validar duraci√≥n del video
    function validateVideoDuration(file){
      return new Promise(res=>{
        const v=document.createElement("video");
        v.preload="metadata";
        v.onloadedmetadata=()=>{ 
          URL.revokeObjectURL(v.src); 
          res(v.duration <= 30); 
        };
        v.onerror=()=>{ res(false); }; // Manejar error al cargar el video
        v.src=URL.createObjectURL(file);
      });
    }

    // Enviar sugerencia
    async function submitSuggestion(){
      if (!auth.currentUser) {
          message.textContent = "Debes iniciar sesi√≥n para enviar una sugerencia.";
          return;
      }

      const t=suggestionTitle.value.trim(),
            txt=suggestionText.value.trim(),
            vid=videoInput.files[0],
            imgs=imageInput.files;
            
      message.textContent=""; // Limpiar mensajes anteriores

      if(!t||!txt){ 
        message.textContent="T√≠tulo y texto son obligatorios."; 
        return; 
      }
      if(imgs.length > 3){ 
        message.textContent="M√°ximo 3 im√°genes permitidas."; 
        return; 
      }
      if(vid && !(await validateVideoDuration(vid))){
        message.textContent="El video debe durar como m√°ximo 30 segundos.";
        return;
      }
      
      let videoURL="", imageURLs=[];
      try{
        if(vid) videoURL=await uploadFile(vid,`sugerencias/videos/${Date.now()}_${vid.name}`);
        for(let i=0; i < imgs.length; i++){
          imageURLs.push(await uploadFile(imgs[i],`sugerencias/imagenes/${Date.now()}_${imgs[i].name}`));
        }
        await db.collection("sugerencias").add({
          title:t, 
          text:txt, 
          videoURL, 
          imageURLs,
          viewCount:0, 
          likes: {}, // Mapeo de userID a true/false para likes/dislikes
          favorites: {}, // Para que el admin marque favoritos
          timestamp:firebase.firestore.FieldValue.serverTimestamp(),
          authorId: auth.currentUser.uid, // ID del autor
          authorName: auth.currentUser.displayName || auth.currentUser.email.split("@")[0] // Nombre del autor
        });
        message.textContent="¬°Sugerencia enviada con √©xito!";
        suggestionTitle.value=""; 
        suggestionText.value="";
        videoInput.value=""; 
        imageInput.value="";
        loadSuggestions(); // Recargar la lista para mostrar la nueva sugerencia
      }catch(e){
        console.error("Error al enviar sugerencia:", e);
        message.textContent="Error al enviar la sugerencia: " + e.message;
      }
    }

    // Cargar y mostrar sugerencias
    async function loadSuggestions(){
      const ul=suggestionList;
      ul.innerHTML="";
      let q=db.collection("sugerencias");
      const f=filterSelect.value;
      
      if(f==="mostViewed") q=q.orderBy("viewCount","desc");
      else if(f==="recent") q=q.orderBy("timestamp","desc");
      else if(f==="old") q=q.orderBy("timestamp","asc");

      try {
        const snap=await q.get();
        if (snap.empty) {
            ul.innerHTML = '<li style="text-align: center; color: #aaa;">No hay sugerencias disponibles.</li>';
            return;
        }

        snap.forEach(doc=>{
          const d=doc.data();
          const li=document.createElement("li");
          li.dataset.id = doc.id; // Guarda el ID del documento
          li.innerHTML=`
            <strong>${d.title}</strong><br>
            ${d.text}
            <div class="suggestion-meta">
                <span>üëÅ ${d.viewCount || 0}</span>
                <span>üëç ${Object.values(d.likes || {}).filter(val => val === true).length}</span>
                <span>üëé ${Object.values(d.likes || {}).filter(val => val === false).length}</span>
            </div>
            <div class="suggestion-actions"></div>
          `;
          
          const actionsDiv = li.querySelector(".suggestion-actions");

          // Botones para usuarios normales
          if (auth.currentUser && !window.isAdmin) {
              const likeBtn = document.createElement("button");
              likeBtn.textContent = "üëç Like";
              likeBtn.onclick = (e) => { e.stopPropagation(); likeSuggestion(doc.id); };
              actionsDiv.appendChild(likeBtn);

              const dislikeBtn = document.createElement("button");
              dislikeBtn.textContent = "üëé Dislike";
              dislikeBtn.onclick = (e) => { e.stopPropagation(); dislikeSuggestion(doc.id); };
              actionsDiv.appendChild(dislikeBtn);

              // Actualizar el estado visual de los botones de like/dislike
              updateReactionUI(doc.id, likeBtn, dislikeBtn, d.likes);
          }
          
          // Botones para administrador
          if (window.isAdmin) {
              // Bot√≥n de Favorito
              const favBtn = document.createElement("button");
              favBtn.textContent = "‚òÖ Favorito";
              favBtn.classList.add('admin-action-btn', 'favorite');
              favBtn.onclick = (e) => { e.stopPropagation(); markFavorite(doc.id); };
              // Opcional: mostrar visualmente si el admin ya lo marc√≥
              if (d.favorites && d.favorites.admin === true) {
                  favBtn.classList.add('active');
              }
              actionsDiv.appendChild(favBtn);

              // Bot√≥n de Eliminar
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "üóë Eliminar";
              deleteBtn.classList.add('admin-action-btn');
              deleteBtn.onclick = (e) => { e.stopPropagation(); deleteSuggestion(doc.id, d.videoURL, d.imageURLs); };
              actionsDiv.appendChild(deleteBtn);
          }

          li.onclick=()=>incrementView(doc.id); // Incrementa la vista al hacer clic
          ul.appendChild(li);
        });
      } catch (e) {
        console.error("Error al cargar sugerencias:", e);
        ul.innerHTML = '<li style="text-align: center; color: red;">Error al cargar las sugerencias.</li>';
      }
    }

    // Actualiza el estado visual de los botones de like/dislike
    function updateReactionUI(suggestionId, likeBtn, dislikeBtn, likesMap) {
        const userId = auth.currentUser ? auth.currentUser.uid : null;
        if (!userId) return;

        likeBtn.classList.remove('active');
        dislikeBtn.classList.remove('active');

        if (likesMap && likesMap[userId] === true) {
            likeBtn.classList.add('active');
        } else if (likesMap && likesMap[userId] === false) {
            dislikeBtn.classList.add('active');
        }
    }

    // Vistas/Reacciones
    async function incrementView(id){
      let uid = auth.currentUser ? auth.currentUser.uid : localStorage.getItem("tempUserId");
      if(!uid){ 
        uid="anon_"+Math.random().toString(36).substr(2,9); 
        localStorage.setItem("tempUserId",uid); 
      }
      
      let viewedSuggestions = JSON.parse(localStorage.getItem("viewedSuggestions_" + uid) || "[]");
      
      if(!viewedSuggestions.includes(id)){
        viewedSuggestions.push(id); 
        localStorage.setItem("viewedSuggestions_" + uid, JSON.stringify(viewedSuggestions));
        try {
          await db.collection("sugerencias").doc(id)
                  .update({viewCount:firebase.firestore.FieldValue.increment(1)});
          loadSuggestions(); // Recargar para actualizar el contador de vistas
        } catch (e) {
            console.error("Error al incrementar vista:", e);
        }
      }
    }
    
    // Funciones de Like/Dislike para usuarios
    async function likeSuggestion(id){
      if (!auth.currentUser) {
          alert("Debes iniciar sesi√≥n para votar.");
          return;
      }
      const userId = auth.currentUser.uid;
      try {
          // Comprobar si ya vot√≥
          const docRef = db.collection("sugerencias").doc(id);
          const docSnap = await docRef.get();
          const currentLikes = docSnap.data().likes || {};

          if (currentLikes[userId] === true) { // Si ya le dio like, desmarcar
              await docRef.update({ [`likes.${userId}`]: firebase.firestore.FieldValue.delete() });
          } else { // Si no ha votado o dio dislike, dar like
              await docRef.update({ [`likes.${userId}`]: true });
          }
          loadSuggestions(); // Recargar para actualizar la UI
      } catch (e) {
          console.error("Error al dar like:", e);
          alert("Error al dar like: " + e.message);
      }
    }

    async function dislikeSuggestion(id){
      if (!auth.currentUser) {
          alert("Debes iniciar sesi√≥n para votar.");
          return;
      }
      const userId = auth.currentUser.uid;
      try {
          const docRef = db.collection("sugerencias").doc(id);
          const docSnap = await docRef.get();
          const currentLikes = docSnap.data().likes || {};

          if (currentLikes[userId] === false) { // Si ya le dio dislike, desmarcar
              await docRef.update({ [`likes.${userId}`]: firebase.firestore.FieldValue.delete() });
          } else { // Si no ha votado o dio like, dar dislike
              await docRef.update({ [`likes.${userId}`]: false });
          }
          loadSuggestions();
      } catch (e) {
          console.error("Error al dar dislike:", e);
          alert("Error al dar dislike: " + e.message);
      }
    }

    // Funciones de admin
    async function markFavorite(id){
      if (!window.isAdmin) { return alert("Acceso denegado: solo el administrador puede marcar como favorito."); }
      try {
        const docRef = db.collection("sugerencias").doc(id);
        const docSnap = await docRef.get();
        const currentFavorites = docSnap.data().favorites || {};
        if (currentFavorites.admin === true) { // Si ya es favorito, quitarlo
            await docRef.update({ 'favorites.admin': firebase.firestore.FieldValue.delete() });
        } else { // Si no es favorito, marcarlo
            await docRef.update({ 'favorites.admin': true });
        }
        loadSuggestions();
      } catch (e) {
        console.error("Error al marcar como favorito:", e);
        alert("Error al marcar como favorito: " + e.message);
      }
    }

    async function deleteSuggestion(id, videoURL, imageURLs){
      if (!window.isAdmin) { 
        alert("Acceso denegado: solo el administrador puede eliminar sugerencias.");
        return;
      }

      if (confirm("¬øEst√°s seguro de que quieres eliminar esta sugerencia? Esta acci√≥n es irreversible.")) {
        try {
          // 1. Eliminar archivos de Storage
          if (videoURL) {
              await deleteFile(videoURL);
          }
          if (imageURLs && imageURLs.length > 0) {
              for (const url of imageURLs) {
                  await deleteFile(url);
              }
          }

          // 2. Eliminar el documento de Firestore
          await db.collection("sugerencias").doc(id).delete();
          alert("Sugerencia eliminada exitosamente.");
          loadSuggestions(); // Recargar la lista
        } catch (e) {
          console.error("Error al eliminar sugerencia:", e);
          alert("Error al eliminar la sugerencia: " + e.message);
        }
      }
    }

    function applyFilter(){ loadSuggestions(); }

    // Cargar sugerencias al inicio y cada vez que el estado de autenticaci√≥n cambie
    document.addEventListener('DOMContentLoaded', () => {
        // La carga inicial se maneja en onAuthStateChanged
    });
  </script>
</body>
</html>
