<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sugerencias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* RESET B√ÅSICO */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#333; color:#fff; font-family:Arial,sans-serif;
      padding:20px; position:relative;
    }
    /* Navegaci√≥n superior izquierda */
    #navButtons {
      position:fixed; top:10px; left:10px; z-index:1000;
    }
    #navButtons button {
      background:#444; border:2px solid #000; color:#fff;
      padding:8px 12px; margin-right:5px; border-radius:4px;
      font-weight:bold; cursor:pointer;
    }
    #navButtons button:hover { background:#555; }
    /* Auth superior derecha */
    #authSection {
      position:fixed; top:10px; right:10px; z-index:1000;
    }
    #authSection span { margin-right:5px; font-size:14px; }
    #authSection button {
      background:#444; border:2px solid #000; color:#fff;
      padding:6px 10px; margin-right:5px; border-radius:4px;
      cursor:pointer;
    }
    #authSection button:hover { background:#555; }
    /* Modales login/registro */
    .modal {
      display:none; position:fixed; top:60px; right:10px;
      background:#444; border:2px solid #000; padding:10px;
      border-radius:4px; z-index:1001;
    }
    .modal input, .modal button {
      display:block; width:200px; margin:5px 0;
    }
    .modal button {
      background:#555; border:none; color:#fff; cursor:pointer;
    }
    /* Layout dos columnas */
    .main-container {
      display:flex; gap:20px; margin-top:60px;
    }
    /* Izquierda: lista */
    .left-sidebar {
      width:60%; background:#222; padding:10px;
      border-radius:4px; max-height:600px; overflow-y:auto;
    }
    .left-sidebar h2 { text-align:center; margin-bottom:10px; }
    .left-sidebar ul { list-style:none; }
    .left-sidebar li {
      padding:8px; border-bottom:1px solid #444;
      font-size:14px; cursor:pointer;
    }
    .left-sidebar li:hover { background:#444; }
    /* Derecha: formulario */
    .right-container {
      width:35%; background:#000; padding:20px;
      border-radius:4px;
    }
    .right-container h1 {
      text-align:center; margin-bottom:20px; font-size:24px;
    }
    .suggestion-input input[type="text"],
    .suggestion-input textarea {
      width:100%; padding:8px; margin-bottom:10px;
      border:1px solid #555; border-radius:4px; font-size:14px;
    }
    .suggestion-input label { margin:10px 0 5px; display:block; }
    .suggestion-input input[type="file"] { margin-bottom:10px; }
    .suggestion-input button {
      background:#444; color:#fff; border:none;
      border-radius:4px; padding:10px 20px;
      cursor:pointer; font-size:14px;
    }
    .suggestion-input button:hover { background:#555; }
    .message { margin-top:10px; font-size:14px; text-align:center; }
    /* Filtro */
    .filter-section {
      margin-top:20px; text-align:center;
    }
    .filter-section select {
      padding:8px; font-size:14px;
      border:1px solid #555; border-radius:4px;
      background:#222; color:#fff;
    }
  </style>
</head>
<body>

  <!-- Navegaci√≥n -->
  <div id="navButtons">
    <button onclick="history.back()">Regresar</button>
    <button onclick="window.location.href='index.html'">Inicio</button>
  </div>

  <!-- Autenticaci√≥n -->
  <div id="authSection">
    <span id="userStatus">No autenticado</span>
    <button id="loginBtn" onclick="showLoginForm()">Iniciar Sesi√≥n</button>
    <button id="registerBtn" onclick="showRegisterForm()">Registrarse</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">Cerrar Sesi√≥n</button>
  </div>

  <!-- Modal Login -->
  <div id="loginModal" class="modal">
    <input type="text" id="loginUsername" placeholder="Username">
    <input type="password" id="loginPassword" placeholder="Password">
    <button onclick="login()">Iniciar Sesi√≥n</button>
    <button onclick="hideLoginForm()">Cancelar</button>
  </div>

  <!-- Modal Registro -->
  <div id="registerModal" class="modal">
    <input type="text" id="registerUsername" placeholder="Username">
    <input type="password" id="registerPassword" placeholder="Password">
    <button onclick="register()">Registrarse</button>
    <button onclick="hideRegisterForm()">Cancelar</button>
  </div>

  <!-- Contenedor principal -->
  <div class="main-container">
    <!-- Lista de sugerencias -->
    <div class="left-sidebar">
      <h2>Comentarios</h2>
      <ul id="suggestionList"></ul>
    </div>
    <!-- Formulario de nueva sugerencia -->
    <div class="right-container">
      <h1>Nueva Sugerencia</h1>
      <div class="suggestion-input">
        <input type="text" id="suggestionTitle" placeholder="T√≠tulo de la sugerencia">
        <textarea id="suggestionText" rows="3" placeholder="Escribe tu sugerencia..."></textarea>
        <label>Adjunta un video (m√°x. 30 segundos):</label>
        <input type="file" id="videoInput" accept="video/*">
        <label>Adjunta hasta 3 im√°genes:</label>
        <input type="file" id="imageInput" accept="image/*" multiple>
        <button onclick="submitSuggestion()">Enviar Sugerencia</button>
        <div class="message" id="message"></div>
      </div>
      <!-- Filtro -->
      <div class="filter-section">
        <select id="filterSelect" onchange="applyFilter()">
          <option value="mostViewed" selected>M√°s Vistos</option>
          <option value="recent">Recientes</option>
          <option value="old">Antiguos</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    // Tu configuraci√≥n de Firebase:
    const firebaseConfig = {
      apiKey: "AIzaSyBeYqGEf_JRCtjHDz5xY3VJ30SJVBqjS8M",
      authDomain: "innovaccionunefa.firebaseapp.com",
      databaseURL: "https://innovaccionunefa-default-rtdb.firebaseio.com",
      projectId: "innovaccionunefa",
      storageBucket: "innovaccionunefa.firebasestorage.app",
      messagingSenderId: "613542800676",
      appId: "1:613542800676:web:82dd0a37ddb8de750a97b1",
      measurementId: "G-LLK0GLWS1G"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Monitorear estado de autenticaci√≥n
    auth.onAuthStateChanged(user => {
      const status = document.getElementById("userStatus");
      if (user) {
        const name = user.displayName || user.email.split("@")[0];
        status.textContent = name;
        loginBtn.style.display = "none";
        registerBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        window.isAdmin = name.toLowerCase() === "chamoprogramador";
      } else {
        status.textContent = "No autenticado";
        loginBtn.style.display = "inline-block";
        registerBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        window.isAdmin = false;
      }
      loadSuggestions();
    });

    // Mostrar/ocultar modales
    function showLoginForm(){ loginModal.style.display="block"; }
    function hideLoginForm(){ loginModal.style.display="none"; }
    function showRegisterForm(){ registerModal.style.display="block"; }
    function hideRegisterForm(){ registerModal.style.display="none"; }

    // Autenticaci√≥n user/pass simulada con email dummy
    function login(){
      const u = loginUsername.value.trim(), p = loginPassword.value;
      if(!u||!p){ return alert("Usuario y contrase√±a obligatorios."); }
      const email = u.toLowerCase()+"@dummy.com";
      auth.signInWithEmailAndPassword(email,p)
        .then(() => hideLoginForm())
        .catch(e => alert(e.message));
    }
    function register(){
      const u = registerUsername.value.trim(), p = registerPassword.value;
      if(!u||!p){ return alert("Usuario y contrase√±a obligatorios."); }
      const email = u.toLowerCase()+"@dummy.com";
      auth.createUserWithEmailAndPassword(email,p)
        .then(cred => cred.user.updateProfile({displayName:u}))
        .then(() => hideRegisterForm())
        .catch(e => alert(e.message));
    }
    function logout(){ auth.signOut(); }

    // Subir archivo a Storage
    async function uploadFile(file,path){
      const ref = storage.ref(path);
      await ref.put(file);
      return ref.getDownloadURL();
    }
    // Validar duraci√≥n del video
    function validateVideoDuration(file){
      return new Promise(res=>{
        const v=document.createElement("video");
        v.preload="metadata";
        v.onloadedmetadata=()=>{ URL.revokeObjectURL(v.src); res(v.duration<=30); };
        v.onerror=()=>res(false);
        v.src=URL.createObjectURL(file);
      });
    }

    // Enviar sugerencia
    async function submitSuggestion(){
      const t=document.getElementById("suggestionTitle").value.trim(),
            txt=document.getElementById("suggestionText").value.trim(),
            vid=videoInput.files[0],
            imgs=imageInput.files,
            msg=message;
      msg.textContent="";
      if(!t||!txt){ return msg.textContent="T√≠tulo y texto son obligatorios."; }
      if(imgs.length>3){ return msg.textContent="M√°x. 3 im√°genes."; }
      if(vid && !(await validateVideoDuration(vid))){
        return msg.textContent="Video debe durar ‚â§30s.";
      }
      let videoURL="", imageURLs=[];
      try{
        if(vid) videoURL=await uploadFile(vid,`sugerencias/videos/${Date.now()}_${vid.name}`);
        for(let f of imgs){
          imageURLs.push(await uploadFile(f,`sugerencias/imagenes/${Date.now()}_${f.name}`));
        }
        await db.collection("sugerencias").add({
          title:t, text:txt, videoURL, imageURLs,
          viewCount:0, likes:{}, favorites:{},
          timestamp:firebase.firestore.FieldValue.serverTimestamp()
        });
        msg.textContent="¬°Enviado con √©xito!";
        suggestionTitle.value=""; suggestionText.value="";
        videoInput.value=""; imageInput.value="";
        loadSuggestions();
      }catch(e){
        console.error(e);
        msg.textContent="Error al enviar.";
      }
    }

    // Cargar y mostrar sugerencias
    async function loadSuggestions(){
      const ul=suggestionList;
      ul.innerHTML="";
      let q=db.collection("sugerencias");
      const f=filterSelect.value;
      if(f==="mostViewed") q=q.orderBy("viewCount","desc");
      if(f==="recent")     q=q.orderBy("timestamp","desc");
      if(f==="old")        q=q.orderBy("timestamp","asc");
      const snap=await q.get();
      snap.forEach(doc=>{
        const d=doc.data();
        const li=document.createElement("li");
        li.innerHTML=`<strong>${d.title}</strong><br>${d.text}<br>üëÅ ${d.viewCount||0}`;
        if(window.isAdmin){
          li.innerHTML+=` <button onclick="markFavorite('${doc.id}')">‚òÖ</button>
                         <button onclick="markDislike('${doc.id}')">Dislike</button>`;
        } else {
          li.innerHTML+=` <button onclick="likeSuggestion('${doc.id}')">Like</button>
                         <button onclick="dislikeSuggestion('${doc.id}')">Dislike</button>`;
        }
        li.onclick=()=>incrementView(doc.id);
        ul.appendChild(li);
      });
    }

    // Vistas/Reacciones
    async function incrementView(id){
      let uid=localStorage.getItem("userId");
      if(!uid){ uid="user_"+Math.random().toString(36).substr(2,9); localStorage.setItem("userId",uid); }
      let vs=JSON.parse(localStorage.getItem("viewedSuggestions")||"[]");
      if(!vs.includes(id)){
        vs.push(id); localStorage.setItem("viewedSuggestions",JSON.stringify(vs));
        await db.collection("sugerencias").doc(id)
                .update({viewCount:firebase.firestore.FieldValue.increment(1)});
        loadSuggestions();
      }
    }
    async function likeSuggestion(id){
      let uid=localStorage.getItem("userId")||"user_"+Math.random().toString(36).substr(2,9);
      localStorage.setItem("userId",uid);
      await db.collection("sugerencias").doc(id)
              .update({[`likes.${uid}`]:true});
      loadSuggestions();
    }
    async function dislikeSuggestion(id){
      let uid=localStorage.getItem("userId")||"user_"+Math.random().toString(36).substr(2,9);
      localStorage.setItem("userId",uid);
      await db.collection("sugerencias").doc(id)
              .update({[`likes.${uid}`]:false});
      loadSuggestions();
    }
    async function markFavorite(id){
      await db.collection("sugerencias").doc(id)
              .update({[`favorites.admin`]:true});
      loadSuggestions();
    }
    async function markDislike(id){
      await db.collection("sugerencias").doc(id)
              .update({[`favorites.admin`]:false});
      loadSuggestions();
    }

    function applyFilter(){ loadSuggestions(); }
    filterSelect.addEventListener("change",applyFilter);

    // Inicio
    loadSuggestions();
  </script>
</body>
</html>
